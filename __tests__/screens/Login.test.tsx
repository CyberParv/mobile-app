import React from 'react'; import { fireEvent, render, waitFor } from '@testing-library/react-native'; import Login from '@/app/(auth)/login'; import { mockApi, renderWithProviders } from '../utils/test-utils'; import { useAuth } from '@/hooks/useAuth'; jest.mock('@/hooks/useAuth'); describe('Login Screen', () => { beforeEach(() => { mockApi(); }); it('renders email and password inputs', () => { const { getByPlaceholderText } = renderWithProviders(<Login />); expect(getByPlaceholderText('Email')).toBeTruthy(); expect(getByPlaceholderText('Password')).toBeTruthy(); }); it('shows validation errors for empty fields on submit', async () => { const { getByText, getByRole } = renderWithProviders(<Login />); fireEvent.press(getByRole('button')); await waitFor(() => { expect(getByText('Email is required')).toBeTruthy(); expect(getByText('Password is required')).toBeTruthy(); }); }); it('shows validation error for invalid email format', async () => { const { getByText, getByPlaceholderText, getByRole } = renderWithProviders(<Login />); fireEvent.changeText(getByPlaceholderText('Email'), 'invalid-email'); fireEvent.press(getByRole('button')); await waitFor(() => { expect(getByText('Invalid email format')).toBeTruthy(); }); }); it('calls login() with credentials on valid submit', async () => { const login = jest.fn(); useAuth.mockReturnValue({ login }); const { getByPlaceholderText, getByRole } = renderWithProviders(<Login />); fireEvent.changeText(getByPlaceholderText('Email'), 'test@example.com'); fireEvent.changeText(getByPlaceholderText('Password'), 'Password123!'); fireEvent.press(getByRole('button')); await waitFor(() => { expect(login).toHaveBeenCalledWith('test@example.com', 'Password123!'); }); }); it('shows loading state during login', async () => { const { getByRole, getByTestId } = renderWithProviders(<Login />); fireEvent.press(getByRole('button')); expect(getByTestId('spinner')).toBeTruthy(); }); it('shows error message when login fails (401)', async () => { useAuth.mockReturnValue({ login: jest.fn().mockRejectedValue({ response: { status: 401 } }) }); const { getByText, getByRole } = renderWithProviders(<Login />); fireEvent.press(getByRole('button')); await waitFor(() => { expect(getByText('Invalid credentials')).toBeTruthy(); }); }); it('shows error message when network is down', async () => { useAuth.mockReturnValue({ login: jest.fn().mockRejectedValue(new Error('Network Error')) }); const { getByText, getByRole } = renderWithProviders(<Login />); fireEvent.press(getByRole('button')); await waitFor(() => { expect(getByText('Network error, please try again later')).toBeTruthy(); }); }); it('navigates to main app on successful login', async () => { const navigate = jest.fn(); useAuth.mockReturnValue({ login: jest.fn().mockResolvedValue(), navigate }); const { getByRole } = renderWithProviders(<Login />); fireEvent.press(getByRole('button')); await waitFor(() => { expect(navigate).toHaveBeenCalledWith('MainApp'); }); }); it('navigates to signup screen when link tapped', () => { const navigate = jest.fn(); const { getByText } = renderWithProviders(<Login />); fireEvent.press(getByText('Sign up')); expect(navigate).toHaveBeenCalledWith('Signup'); }); });